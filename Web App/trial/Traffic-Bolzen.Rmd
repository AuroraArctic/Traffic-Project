---
output: 
  flexdashboard::flex_dashboard:
    theme: yeti
    # css: styles.css
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
# Libraries
library("shinythemes")
library("flexdashboard")
library("DBI")
library("dplyr")
library("ggplot2")
library("tidyverse")
library("shinyWidgets")
library("shiny")
library("plotly")
library("scales")
library("DT")
library("leaflet")
library("leaflet.extras")
library("maps")

source("mysql_connection.R")
library("RMariaDB")

# Establish connectiong to MySQL
con <- dbconnect()
```


Real time traffic
=====================================  
```{r}
renderPlotly({
  mapboxToken <- config::get(file = "config.yml")$mapbox
  Sys.setenv("MAPBOX_TOKEN" = mapboxToken) # for Orca
  
  df = read.csv('../../data/2021-06-10.csv')%>%
    inner_join(dbGetQuery(con, paste0(
      "SELECT *
       FROM bluetoothstations.station"
    )),by = c("station"="name"))
  fig <- df %>% plot_mapbox(lat = ~latitude, lon = ~longitude,
                            color = count,
                            mode = 'scattermapbox', 
                            hoverinfo='station') 
  fig <- fig %>% layout(title = 'Number of vehicles by Station',
                        font = list(color='white'),
                        plot_bgcolor = '#191A1A', paper_bgcolor = '#191A1A',
                        mapbox = list(style = 'dark'),
                        legend = list(orientation = 'h',
                                      font = list(size = 8)),
                        margin = list(l = 25, r = 25,
                                      b = 25, t = 25,
                                      pad = 2)) 
  fig <- fig %>% config(mapboxAccessToken = Sys.getenv("MAPBOX_TOKEN"))
  
  fig
})
```



Stations
=====================================   

```{r}
# List of stations
stations = c(dbGetQuery(con, paste0(
      "SELECT name
       FROM bluetoothstations.station"
    )))

# Search bar for the stations
selectInput(inputId = "station", 
            label = "Select a station",
            choices = c("All",stations),
            width = "100%")
```

Column {data-width=600}
-------------------------------------
    
### Stations

```{r}
# Creating the map that shows the selected station
renderLeaflet({
  # Show all stations
  if(input$station[1]!="All"){
    df = dbGetQuery(con, paste0(
      "SELECT *
       FROM bluetoothstations.station
       WHERE name ='",input$station[1],"'"
    ))
    # Show the selected station
  }else{
    df = dbGetQuery(con, paste0(
      "SELECT *
       FROM bluetoothstations.station"))
  }
  # Creating the map, with lat and lon set to Bolzen
  leaflet(df) %>% 
    setView(lng = 11.2, lat = 46.40, zoom =9)  %>%
    addTiles() %>% 
    addMarkers(data = df, 
               lat = ~ latitude,
               lng = ~ longitude, 
               popup = ~as.character(name), 
               label = ~as.character(paste0("Name: ", sep = " ", name)))
})
```
   
Column {data-width=600}
-------------------------------------
   
### Traffic per hour

```{r}
renderPlotly({
  # Plot the traffic of the specific station
  if(input$station[1]!="All"){
    traffic_s = dbGetQuery(con,paste0("
                                      SELECT hour(timestamp) as time,AVG(count) as traffic
                                      FROM bluetoothstations.measurement as m
                                      WHERE station = '",input$station[1],"'
                                      GROUP BY hour(timestamp)
                                      ORDER BY time"))
  # Plot the traffic of the overall stations
  }else{
    traffic_s = dbGetQuery(con,paste0("
                                      SELECT hour(timestamp) as time,AVG(count) as traffic
                                      FROM bluetoothstations.measurement as m
                                      GROUP BY hour(timestamp)
                                      ORDER BY time;"))
  }
  plot_ly(data = traffic_s, x = ~time, y = ~traffic, mode = 'lines')
})
```

History {data-orientation=rows}
=====================================    

```{r}
latest_data = "SELECT date(MAX(timestamp)) FROM bluetoothstations.station"

dateRangeInput(inputId = "pickup_date", 
  label = 'Date:', 
  start = Sys.Date()-5, 
  end = Sys.Date(), 
  min = "2013-01-01",
  max = latest_data,
  startview = "year")
```


```{r}
renderPlotly({
  #data = dbGetQuery(con,paste0(
  #  "SELECT timestamp, SUM(count) as vehicles
  #  FROM bluetoothstations.measurement 
  #  WHERE timestamp BETWEEN '",input$pickup_date[1],"' AND '",input$pickup_date[2],"'
  #  GROUP BY timestamp
  #  ORDER BY timestamp;"  
  #))
  data = dbGetQuery(con,paste0("call bluetoothstations.timerange_count('",input$pickup_date[1],"','",input$pickup_date[2],"');"))
  plot_ly(data = data, x = ~timestamp, y = ~vehicles, mode = 'lines')
})
```





Timing trends {data-orientation=rows}
=====================================    

Row
-------------------------------------

### Traffic for weekdays
```{r}
renderPlotly({
  palette = c()
  data = dbGetQuery(con,paste0("call bluetoothstations.traffic_weekdays();"))
  plot_ly(data = data, x = ~hour) %>%
    add_lines(y = ~vehicles,color = ~weekday,
              color_discrete_sequence = palette)
})
```

Row 
-------------------------------------
### Traffic for months



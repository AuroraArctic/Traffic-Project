---
title: "Traffic in Bolzen"
output: 
  flexdashboard::flex_dashboard:
    theme: yeti
    # css: styles.css
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
# Libraries
library("shinythemes")
library("flexdashboard")
library("DBI")
library("dplyr")
library("ggplot2")
library("tidyverse")
library("shinyWidgets")
library("shiny")
library("plotly")
library("scales")
library("DT")
library("leaflet")
library("leaflet.extras")
library("maps")

source("mysql_connection.R")
library("RMariaDB")

# Establish connectiong to MySQL
con <- dbconnect()
```


Real time traffic
=====================================  
```{r}
selectInput(inputId = "map_style", 
            label = "Select a style",
            choices = c("streets","open-street-map","light","dark"),
            width = "100%")


palettes = list("streets" = pals::kovesi.diverging_rainbow_bgymr_45_85_c67(5),
                 "open-street-map" = pals::kovesi.linear_bmy_10_95_c78(5),
                 "light" = pals::brewer.ylorrd(10),
                 "dark" = pals::plasma(50))

```

Column {data-width=600}
-------------------------------------
### Traffic prediction

```{r}
renderPlotly({
  
  # Inserting token of mapbox for styling
  mapboxToken <- config::get(file = "config.yml")$mapbox
  Sys.setenv("MAPBOX_TOKEN" = mapboxToken) # for Orca
  
  # Loading data
  df = read.csv('2021-06-10.csv')%>%
    arrange(desc(timestamp)) %>%
    filter(timestamp == "2021-06-10 15:00:00" ) %>%
    inner_join(dbGetQuery(con, paste0(
      "SELECT * FROM bluetoothstations.station 
       WHERE latitude IS NOT NULL and longitude IS NOT NULL;"
    )),by = c("station"="name"))
  
  # Plotting
  map_style = input$map_style[1]
  plot_mapbox(df) %>%
  add_markers(
    x = ~longitude, 
    y = ~latitude, 
    size = ~count, 
    color = ~count,
    colors = palettes[map_style][[1]],
    text = ~paste(station,
                  '</br></br>Vehicles: ', count),
    hoverinfo = "text",
    marker=list(opacity = 1,
                size = seq(200,500))
  )%>%
    layout(
      mapbox = list(
        style = map_style,
        zoom = 12,
        center = list(lon = 11.35, lat = 46.485)),
      margin = list(l = 0, r = 0,
                    b = 0, t = 0,
                    pad = 0))
})%>%
bindCache(input$map_style)
```




Stations
=====================================   

```{r}
# List of stations
stations = c(dbGetQuery(con, paste0(
      "SELECT name
       FROM bluetoothstations.station"
    )))

# Search bar for the stations
selectInput(inputId = "station", 
            label = "Select a station",
            choices = c("All",stations),
            width = "50%")
selectInput(inputId = "map_style_2", 
            label = "Select a style",
            choices = c("streets","open-street-map","light","dark"),
            width = "50%")
```

Column {data-width=600}
-------------------------------------
    
### Stations

```{r}
# Creating the map that shows the selected station
renderPlotly({
  # Show all stations
  if(input$station[1]!="All"){
    df = dbGetQuery(con, paste0(
      "SELECT *
       FROM bluetoothstations.station
       WHERE name ='",input$station[1],"'"
    ))
    # Show the selected station
  }else{
    df = dbGetQuery(con, paste0(
      "SELECT *
       FROM bluetoothstations.station"))
  }
  # Inserting token of mapbox for styling
  mapboxToken <- config::get(file = "config.yml")$mapbox
  Sys.setenv("MAPBOX_TOKEN" = mapboxToken) # for Orca
  map_style = input$map_style_2[1]
  plot_mapbox(df) %>%
  add_markers(
    x = ~longitude, 
    y = ~latitude,
    #â€¢colors = palettes[map_style][[1]],
    text = ~name,
    hoverinfo = "text",
    marker=list(opacity = 1,
                size = 10))%>%
    layout(
      mapbox = list(
        #style = map_style,
        zoom = 12,
        center = list(lon = 11.35, lat = 46.485)),
      margin = list(l = 0, r = 0,
                    b = 0, t = 0,
                    pad = 0))
})%>%
bindCache(input$station)
```
   
Column {data-width=600}
-------------------------------------
   
### Traffic per hour

```{r}
renderPlotly({
  # Plot the traffic of the specific station
  if(input$station[1]!="All"){
    traffic_s = dbGetQuery(con,paste0("
                                      SELECT hour(timestamp) as time,AVG(count) as traffic
                                      FROM bluetoothstations.measurement as m
                                      WHERE station = '",input$station[1],"'
                                      GROUP BY hour(timestamp)
                                      ORDER BY time"))
  # Plot the traffic of the overall stations
  }else{
    traffic_s = dbGetQuery(con,paste0("
                                      SELECT hour(timestamp) as time,AVG(count) as traffic
                                      FROM bluetoothstations.measurement as m
                                      GROUP BY hour(timestamp)
                                      ORDER BY time;"))
  }
  plot_ly(data = traffic_s, x = ~time, y = ~traffic, mode = 'lines')
})
```

History {data-orientation=rows}
=====================================    

```{r}
latest_data = "SELECT date(MAX(timestamp)) FROM bluetoothstations.station"

dateRangeInput(inputId = "pickup_date", 
  label = 'Date:', 
  start = Sys.Date()-5, 
  end = Sys.Date(), 
  min = "2013-01-01",
  max = latest_data,
  startview = "year")
```


```{r}
renderPlotly({
  data = dbGetQuery(con,paste0("call bluetoothstations.timerange_count('",input$pickup_date[1],"','",input$pickup_date[2],"');"))
  ggplotly(ggplot(data)+
             geom_smooth(aes(x = timestamp, y = vehicles)))
  
})%>%
bindCache(input$pickup_date)
```





Timing trends 
=====================================    

Column {data-width=600}
-------------------------------------

### Traffic for weekdays
```{r}
renderPlotly({
  palette = c()
  data = dbGetQuery(con,paste0("call bluetoothstations.traffic_weekdays();"))
  plot_ly(data = data, x = ~hour) %>%
    add_lines(y = ~vehicles,color = ~weekday,
              color_discrete_sequence = palette)
})
```


### Traffic for months

```{r}
renderPlotly({
  palette = c()
  data = dbGetQuery(con,paste0("SELECT "))
  season_data = 
  plot_ly(data = data, x = ~hour) %>%
    add_lines(y = ~vehicles,color = ~weekday,
              color_discrete_sequence = palette)
})
```

Column {data-width=400}
-------------------------------------

### Traffic over weekdays and time of the day

```{r}
renderPlotly({
  d = data.frame(
    labels = c("Winter", "Spring","Summer","Autumn",
               "January","February","March",
               "April","May","June",
               "July","August","September",
               "October","November","December"),
    
    parents = c("", "","","",
                "Winter","Winter","Spring",
                "Spring", "Spring", "Summer",
                "Summer","Summer","Autumn",
                "Autumn","Autumn","Winter"),
    
    values = c("25","25","25","25",
               "10","10","10",
               "5","10","10",
               "10","5","15",
               "5","5","5"),
    
    stringAsFactors=FALSE
  )
  plot_ly(d,labels = ~labels,
          parents = ~parents, 
          type = 'sunburst',
          values = ~values,
          branchvalues = 'total')
})
```


### Traffic over different seasons
```{r}
renderPlotly({
  d = data.frame(
    labels = c("Winter", "Spring","Summer","Autumn",
               "January","February","March",
               "April","May","June",
               "July","August","September",
               "October","November","December"),
    
    parents = c("", "","","",
                "Winter","Winter","Spring",
                "Spring", "Spring", "Summer",
                "Summer","Summer","Autumn",
                "Autumn","Autumn","Winter"),
    
    values = c("25","25","25","25",
               "10","10","10",
               "5","10","10",
               "10","5","15",
               "5","5","5"),
    
    stringAsFactors=FALSE
  )
  plot_ly(d,labels = ~labels,
          parents = ~parents, 
          type = 'sunburst',
          values = ~values,
          branchvalues = 'total')
})

```

